name: Build Agent Image (Tool Dispatcher)
run-name: Dispatch ${{ inputs.tool }} builds (${{ github.ref_name }})

"on":
  workflow_call:
    inputs:
      tool:
        description: Tool name to dispatch
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tool:
        description: Tool name to dispatch
        required: true
        type: string

jobs:
  dispatch:
    name: Dispatch ${{ inputs.tool }} builds
    runs-on: ubuntu-latest
    env:
      TOOL: ${{ inputs.tool }}
      REF: ${{ github.ref }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Dispatch per-base builds
        run: |
          set -euo pipefail
          ROOT_DIR="$(pwd)"
          source scripts/common.sh
          load_env_file
          BASE_ALIASES="$(discover_base_aliases)"
          for BASE_ALIAS in ${BASE_ALIASES}; do
            echo "Dispatching ${TOOL} (${BASE_ALIAS}) for ${REF}"
            gh workflow run build.yml --ref "${REF}" -f tool="${TOOL}" -f base="${BASE_ALIAS}"
          done
